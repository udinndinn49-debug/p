<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Forum BarBar â€” Forum Diskusi Orang BarBar</title>
  <meta name="description" content="Platform umum untuk siswa berdiskusi tentang mata pelajaran dan tugas." />

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg: #f7f7fb;
      --bg-gradient-end: #eef6fb;
      --card: #ffffff;
      --muted: #6b7280;
      --text: #0f1724;
      --accent: #0ea5a3;
      --accent-contrast: #ffffff;
      --danger: #ef4444;
      --shadow: 0 6px 18px rgba(12, 17, 23, 0.06);
      --radius: 12px;
      --border: rgba(0,0,0,0.06);
      --input-bg: transparent;
    }
    [data-theme="dark"]{
      --bg: #0f172a;
      --bg-gradient-end: #0f172a;
      --card: #1e293b;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --accent: #06b6d4;
      --accent-contrast: #ffffff;
      --shadow: 0 6px 18px rgba(0,0,0,0.2);
      --border: rgba(255,255,255,0.1);
      --input-bg: rgba(255,255,255,0.03);
    }

    *{box-sizing: border-box}
    html,body{height:100%;}
    body{
      margin:0;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg,var(--bg), var(--bg-gradient-end) 200px);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      padding:28px;
      transition: background 0.2s ease, color 0.2s ease;
    }

    /* === CSS untuk Landing Screen === */
    #landingScreen {
      position: fixed;
      inset: 0; /* shorthand untuk top, right, bottom, left = 0 */
      background: var(--bg);
      z-index: 9999;
      display: grid;
      place-items: center;
      text-align: center;
      transition: opacity 0.4s ease-out;
    }
    .landing-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
    }
    .landing-content h1 { margin: 0; font-size: 28px; }
    .landing-content p { margin: 0; color: var(--muted); max-width: 300px; }

    /* === Sembunyikan Konten Utama Awalnya === */
    .app-header, .container {
      display: none;
    }
    
    .app-header {
      align-items: center;
      gap: 12px;
      padding: 16px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      position: relative; 
      z-index: 998; 
    }

    .container{
      max-width:1100px;
      margin:0 auto;
      grid-template-columns: 1fr; 
      gap:20px;
      align-items:start;
    }

    .sidebar{
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: 320px;
      max-width: 90%;
      background: var(--card);
      box-shadow:var(--shadow);
      padding:18px;
      overflow-y: auto;
      transform: translateX(-100%); 
      transition: transform 0.3s ease-in-out;
      z-index: 1000;
    }
    .sidebar.is-open {
      transform: translateX(0);
    }
    .sidebar-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease-in-out;
      z-index: 999;
    }
    .sidebar-backdrop.is-open {
      opacity: 1;
      pointer-events: auto;
    }
    .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .brand{
      display:flex;
      gap:12px;
      align-items:center;
    }
    .logo{
      width:44px;height:44px;border-radius:10px;
      display:inline-grid;place-items:center;
      background:linear-gradient(135deg,var(--accent), #3b82f6);
      color:var(--accent-contrast); font-weight:700;
      font-size:18px;
    }
    h1.title{font-size:18px;margin:0}
    p.subtitle{margin:4px 0 12px;color:var(--muted);font-size:13px}

    .filter-group{margin-top:8px}
    .filter-group h3{margin:8px 0;font-size:13px;color:var(--muted)}
    .cat-list{display:flex;flex-direction:column;gap:8px}
    .cat-btn{
      text-align:left;padding:8px 10px;border-radius:8px;border:1px solid transparent;
      background:transparent;color:var(--text);cursor:pointer;font-weight:600;
      transition: background 0.15s ease, color 0.15s ease;
    }
    .cat-btn:hover{background:rgba(0,0,0,0.03)}
    [data-theme="dark"] .cat-btn:hover{background:rgba(255,255,255,0.05)}
    .cat-btn.active{background:linear-gradient(90deg,var(--accent), #60a5fa);color:var(--accent-contrast);border-color:rgba(0,0,0,0.05)}

    .theme-toggle{
      display:flex;gap:8px;align-items:center;margin-top:12px;
      justify-content:space-between;
    }
    .btn{
      display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;border:0;background:var(--accent);color:var(--accent-contrast);cursor:pointer;font-weight:600;
      box-shadow: none;
      transition: background 0.15s ease, opacity 0.15s ease;
    }
    .btn:disabled{opacity: 0.7; cursor: wait;}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}

    .btn.icon-btn {
      padding: 8px;
      width: 44px;
      height: 44px;
      display: grid;
      place-items: center;
      flex-shrink: 0;
    }
    .btn.icon-btn svg {
      width: 24px;
      height: 24px;
      stroke: currentColor;
    }
    .btn.icon-btn.close-btn {
      font-size: 28px;
      line-height: 1;
      font-weight: 300;
      width: 36px;
      height: 36px;
    }

    .main{
      min-height:60vh;
    }
    .card{
      background:var(--card);
      padding:16px;
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      margin-bottom:16px;
    }

    .compose h2{margin:0 0 8px}
    .compose form{display:grid;gap:8px}
    .input, textarea, select{
      width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);
      font-size:14px;background:var(--input-bg);color:var(--text);
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    .input:focus, textarea:focus, select:focus{
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent);
    }
    textarea{min-height:100px;resize:vertical}
    .row{display:flex;gap:8px}
    .row .input{flex:1}
    .tags-list{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    .tag-pill{padding:6px 8px;border-radius:999px;background:rgba(0,0,0,0.04);font-size:13px;cursor:pointer}
    .tag-pill:hover{opacity:0.85}

    .searchbar{display:flex;gap:8px;margin-bottom:12px}
    .searchbar input{
      flex:1;
    }
    .searchbar select{
      width: 180px;
      flex-shrink: 0;
    }

    .posts {display:grid;gap:12px}
    .post{
      padding:14px;border-radius:12px;border:1px solid var(--border);
      transition:transform .12s ease;
    }
    .post:hover{transform:translateY(-4px)}
    .post .meta{display:flex;gap:10px;align-items:center;margin-bottom:8px}
    .post .meta .cat{font-size:12px;padding:4px 8px;border-radius:999px;background:rgba(0,0,0,0.04);font-weight:600}
    .post .title{font-size:16px;margin:4px 0 6px}
    .post .body{color:var(--muted);font-size:14px;margin-bottom:8px;white-space:pre-wrap}
    .post .post-tags{display:flex;gap:8px;flex-wrap:wrap}
    .post .post-tags .tag{cursor:pointer;padding:6px 8px;border-radius:999px;background:rgba(0,0,0,0.03);font-size:13px}
    .post .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;}

    .replies-section{
      margin-top: 16px;
      padding-top: 12px;
      border-top: 1px dashed var(--border);
    }
    .reply-card{
      background: var(--input-bg);
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .reply-card .meta{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .reply-form{
      margin-top: 12px;
      display: grid;
      gap: 8px;
    }

    footer.small{font-size:12px;color:var(--muted);text-align:center;margin-top:18px}

    @media (max-width:920px){
      body{padding:14px}
      
      .row { flex-direction: column; }
      .searchbar { flex-direction: column; }
      .searchbar select { width: 100%; }
      .app-header { padding: 12px; }
      h1.title { font-size: 16px; }
    }
  </style>
</head>
<body>

<div id="landingScreen">
    <div class="landing-content">
      <img src="https://res.cloudinary.com/dgzufaone/image/upload/v1761143718/Gemini_Generated_Image_hbfzexhbfzexhbfz-modified_rcnbja.png" alt="Logo Forum BarBar" style="width: 64px; height: 64px; object-fit: cover; border-radius: 50%;">
      <h1>Selamat Datang!</h1>
      <p>Platform Forum Diskusi Untuk Orang BarBar,BarBar Singkatan Dari Belajar Bareng Forum ini hanya untuk diskusi tidak ada unsur negatif dalam forum website ini:v.</p>
      <button id="enterBtn" class="btn">Masuk ke Forum</button>
    </div>
  </div>
  <div id="sidebarBackdrop" class="sidebar-backdrop"></div>
  
<aside class="sidebar" id="sidebarMenu" aria-label="Sidebar">
    
    <div class="sidebar-header">
      <p class="subtitle" style="margin:0; font-weight: 600;">Menu Navigasi</p>
      <button id="sidebarCloseBtn" class="btn ghost icon-btn close-btn" title="Tutup Menu" aria-label="Tutup Menu">&times;</button>
    </div>

    <div class="filter-group" aria-hidden="false">
      <h3>Kategori</h3>
      <div class="cat-list" id="categoryList"></div>
    </div>

    <div class="filter-group">
      <h3>Tag populer</h3>
      <div id="popularTags" class="tags-list" aria-live="polite"></div>
    </div>

    <div class="theme-toggle">
      <div class="muted">Mode</div>
      <div>
        <button id="themeBtn" class="btn ghost" aria-pressed="false">Mode Gelap</button>
      </div>
    </div>
    
  </aside>

<header class="app-header">
    <button id="hamburgerBtn" class="btn ghost icon-btn" title="Buka Menu" aria-label="Buka Menu">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>
    <div class="brand">
      <img src="https://res.cloudinary.com/dgzufaone/image/upload/v1761143718/Gemini_Generated_Image_hbfzexhbfzexhbfz-modified_rcnbja.png" alt="Logo" class="logo" style="background: none; object-fit: cover;">
      <div>
        <h1 class="title">Forum BarBar</h1>
      </div>
    </div>
  </header>

<div class="container" id="app">
    <main class="main">
      <section class="card compose" aria-labelledby="composeTitle">
        <h2 id="composeTitle">Buat Pertanyaan / Topik Baru</h2>
        <form id="composeForm" onsubmit="return false;">
          <input name="title" class="input" placeholder="Judul: Contoh â€” Soal kinematics kelas 10..." required aria-label="Judul Topik"/>
          <textarea name="body" placeholder="Jelaskan detail pertanyaan atau topik..." required aria-label="Isi Topik"></textarea>
          <div class="row">
            <select name="category" class="input" aria-label="Kategori">
              <option value="Matematika">Matematika</option>
              <option value="Sains">Sains</option>
              <option value="Bahasa">Bahasa</option>
              <option value="Sejarah">Sejarah</option>
              <option value="Lainnya">Lainnya</option>
            </select>
            <input name="tags" class="input" placeholder="Tags (pisahkan koma). cth: fisika, integral" aria-label="Tags Topik"/>
            <button id="submitPost" class="btn" type="submit">Posting</button>
          </div>
        </form>
      </section>

      <section class="card" aria-labelledby="browseTitle">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <h2 id="browseTitle" style="margin:0">Topik & Pertanyaan</h2>
          <div class="muted" id="postCount">0 topik</div>
        </div>

        <div class="searchbar">
          <input id="searchInput" placeholder="Cari judul, isi, atau tag..." aria-label="Cari topik" />
          <select id="sortSelect" class="input">
            <option value="new">Terbaru</option>
            <option value="old">Terlama</option>
          </select>
        </div>

        <div class="posts" id="postsContainer" aria-live="polite">
          <div class="post card">
            <div class="muted">Memuat topik dari database...</div>
          </div>
        </div>

        <footer class="small card" style="margin-top:12px; margin-bottom:0;">
          Forum BarBar â€” Belajar bareng itu asik! (Data via Supabase)
        </footer>
      </section>
    </main>
  </div>

  <script>
    /******************************
     * Forum BarBar â€” Supabase Client
     ******************************/
    (function(){
      
      // === Konfigurasi Supabase ===
      // CATATAN PENTING: Ganti URL dan KEY ini dengan punyamu sendiri jika kamu ingin database-nya berfungsi!
      const SUPABASE_URL = 'https://zisateevmyushnucnwfs.supabase.co';
      const SUPABASE_ANON_KEY = 'sb_publishable_-exfRTTm2rD080T-jwesIQ_YaOVKiJp';

      if(SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
        console.warn('Supabase URL/Key belum diatur. Silakan update di dalam <script>.');
        document.getElementById('postsContainer').innerHTML = `
          <div class="post card" style="border-color: var(--danger); background: rgba(239, 68, 68, 0.1);">
            <h3 style="color:var(--danger); margin:0">Koneksi Database Gagal</h3>
            <p style="color:var(--muted)">Konfigurasi Supabase (URL/Key) belum diatur di dalam file HTML.</p>
          </div>`;
        return; 
      }

      const { createClient } = supabase;
      const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      
      // === Akhir Konfigurasi ===

      const CATEGORIES = ["Semua","Matematika","Sains","Bahasa","Sejarah","Lainnya"];
      const LS_THEME = 'forumbarbar_theme_v1';

      // DOM Elements
      const landingScreen = document.getElementById('landingScreen');
      const enterBtn = document.getElementById('enterBtn');
      const appHeader = document.querySelector('.app-header');
      const appContainer = document.querySelector('.container');

      const categoryListEl = document.getElementById('categoryList');
      const popularTagsEl = document.getElementById('popularTags');
      const postsContainer = document.getElementById('postsContainer');
      const postCountEl = document.getElementById('postCount');
      const composeForm = document.getElementById('composeForm');
      const submitPostBtn = document.getElementById('submitPost');
      const searchInput = document.getElementById('searchInput');
      const sortSelect = document.getElementById('sortSelect');
      const themeBtn = document.getElementById('themeBtn');
      
      const hamburgerBtn = document.getElementById('hamburgerBtn');
      const sidebarMenu = document.getElementById('sidebarMenu');
      const sidebarBackdrop = document.getElementById('sidebarBackdrop');
      const sidebarCloseBtn = document.getElementById('sidebarCloseBtn');

      // State (Variabel untuk menyimpan kondisi aplikasi)
      let posts = []; 
      let activeCategory = "Semua";
      let activeTag = null;

      // Inisialisasi Aplikasi
      initializeApp();
      
      async function initializeApp() {
        // Logika untuk tombol masuk (Landing Screen)
        enterBtn.addEventListener('click', () => {
          // 1. Buat landing screen menghilang (fade out)
          landingScreen.style.opacity = '0';
          
          // 2. Setelah animasi selesai, sembunyikan total dan tampilkan konten utama
          setTimeout(() => {
            landingScreen.style.display = 'none';
            appHeader.style.display = 'flex'; // Kembalikan display aslinya
            appContainer.style.display = 'grid'; // Kembalikan display aslinya
          }, 400); // 400ms = durasi transisi di CSS
        });

        renderCategoryButtons();
        applySavedTheme();
        
        // Setup event listeners
        composeForm.addEventListener('submit', handleSubmit);
        // Debounce: Menunda eksekusi fungsi agar tidak terlalu sering (misalnya saat mengetik cepat)
        searchInput.addEventListener('input', debounce(() => renderPosts(), 250)); 
        sortSelect.addEventListener('change', fetchAndRenderPosts);
        themeBtn.addEventListener('click', toggleTheme);
        
        hamburgerBtn.addEventListener('click', openSidebar);
        sidebarCloseBtn.addEventListener('click', closeSidebar);
        sidebarBackdrop.addEventListener('click', closeSidebar);

        // Ambil dan tampilkan postingan pertama kali
        await fetchAndRenderPosts();
        
        // Cek jika ada ID topik di URL hash (misal: #123)
        tryOpenHash();
      }
      
      // Fungsi untuk Sidebar
      function openSidebar() {
        sidebarMenu.classList.add('is-open');
        sidebarBackdrop.classList.add('is-open');
      }
      function closeSidebar() {
        sidebarMenu.classList.remove('is-open');
        sidebarBackdrop.classList.remove('is-open');
      }

      // Fungsi Utama: Mengambil data dari Supabase dan Menampilkan Postingan
      async function fetchAndRenderPosts() {
        postsContainer.innerHTML = `<div class="post card muted">Memuat topik dari database...</div>`;
        const ascending = sortSelect.value === 'old'; // Urutkan: Terlama (true) atau Terbaru (false)
        
        const { data, error } = await db
          .from('posts')
          .select('*, replies (*)') // Ambil postingan dan semua balasan terkait
          .order('created_at', { ascending: ascending });

        if(error) {
          console.error('Error fetching posts:', error.message);
          postsContainer.innerHTML = `<div class="post card muted">Gagal memuat data: ${error.message}</div>`;
          return;
        }
        
        posts = data || []; // Simpan data di variabel state
        renderPosts(); // Tampilkan data yang sudah difilter/dicari
        renderPopularTags(); // Hitung dan tampilkan tag populer
      }
      
      // Helper untuk memproses tag
      function normalizeTagText(text){
        return text.replace(/^[#]+/,'').toLowerCase().trim();
      }

      function parseTags(input){
        if(!input) return [];
        return input.split(/[,\\s]+/).map(t => normalizeTagText(t)).filter(Boolean);
      }

      // Render Tombol Kategori di Sidebar
      function renderCategoryButtons(){
        categoryListEl.innerHTML = '';
        CATEGORIES.forEach(cat => {
          const btn = document.createElement('button');
          btn.className = 'cat-btn' + (cat === activeCategory ? ' active' : '');
          btn.textContent = cat;
          btn.type = 'button';
          btn.addEventListener('click', () => {
            activeCategory = cat;
            activeTag = null;
            updateCategoryActiveStates();
            renderPosts(); 
            closeSidebar(); 
          });
          categoryListEl.appendChild(btn);
        });
      }

      function updateCategoryActiveStates(){
        [...categoryListEl.children].forEach(btn => {
          btn.classList.toggle('active', btn.textContent === activeCategory);
        });
      }

      // Menghitung Tag Populer
      function computePopularTags(){
        const counter = {};
        posts.forEach(p => p.tags.forEach(t => counter[t] = (counter[t]||0)+1));
        return Object.keys(counter).sort((a,b)=>counter[b]-counter[a]).slice(0,12);
      }

      // Render Tag Populer di Sidebar
      function renderPopularTags(){
        popularTagsEl.innerHTML = '';
        const tags = computePopularTags();
        if(!tags.length){
          popularTagsEl.innerHTML = '<div class="muted">Belum ada tag populer.</div>';
          return;
        }
        tags.forEach(t => {
          const el = document.createElement('div');
          el.className = 'tag-pill';
          el.textContent = '#'+t;
          el.title = 'Filter tag #'+t;
          el.addEventListener('click', () => {
            activeTag = t;
            activeCategory = 'Semua';
            updateCategoryActiveStates();
            renderPosts();
            closeSidebar(); 
          });
          popularTagsEl.appendChild(el);
        });
      }

      // Memfilter dan Menampilkan Postingan
      function renderPosts(){
        const q = (searchInput.value||'').toLowerCase().trim();
        let list = posts.slice();

        // Filter berdasarkan Kategori
        if(activeCategory && activeCategory !== 'Semua'){
          list = list.filter(p => p.category === activeCategory);
        }

        // Filter berdasarkan Tag
        if(activeTag){
          list = list.filter(p => p.tags.includes(activeTag));
        }

        // Filter berdasarkan Pencarian (Judul, Isi, atau Tag)
        if(q){
          list = list.filter(p =>
            p.title.toLowerCase().includes(q) ||
            p.body.toLowerCase().includes(q) ||
            p.tags.some(t => t.includes(q.replace(/^#/,'')))
          );
        }
        
        postsContainer.innerHTML = '';
        if(!list.length){
          const empty = document.createElement('div');
          empty.className = 'post card';
          empty.innerHTML = '<div class="muted">Belum ada topik yang cocok. Coba buat topik baru atau ubah filter.</div>';
          postsContainer.appendChild(empty);
        } else {
          list.forEach(p => postsContainer.appendChild(renderPostCard(p)));
        }

        postCountEl.textContent = `${list.length} topik`;
      }
      
      // Render Balasan untuk sebuah Postingan
      function renderReplies(post, container){
        container.innerHTML = '';
        const replies = post.replies || [];
        if(!replies.length) return;

        replies.sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
        
        replies.forEach(r => {
          const replyEl = document.createElement('div');
          replyEl.className = 'reply-card';
          replyEl.innerHTML = `
            <div class="meta">${formatDate(new Date(r.created_at))}</div>
            <div class="body">${escapeHtml(r.body)}</div>
          `;
          container.appendChild(replyEl);
        });
      }

      // Membuat elemen HTML untuk Postingan
      function renderPostCard(p){
        const el = document.createElement('article');
        el.className = 'post card';
        el.setAttribute('data-id', p.id); // Penting untuk fungsi tryOpenHash
        const date = new Date(p.created_at);

        el.innerHTML = `
          <div class="meta">
            <div class="cat" aria-hidden="true">${escapeHtml(p.category)}</div>
            <div style="font-size:13px;color:var(--muted)">${formatDate(date)}</div>
          </div>
          <div class="title">${escapeHtml(p.title)}</div>
          <div class="body">${escapeHtml(p.body)}</div>
          <div class="post-tags"></div>
          <div class="replies-section"></div>
          
          <div class="actions">
            <button class="btn ghost shareBtn" title="Salin link topik">Salin Link</button>
            </div>

          <form class="reply-form">
            <textarea name="replyBody" class="input" placeholder="Tulis balasan..." required aria-label="Tulis balasan untuk ${escapeHtml(p.title)}"></textarea>
            <button type="submit" class="btn" style="justify-self:flex-end">Kirim Balasan</button>
          </form>
        `;
        
        const tagsContainer = el.querySelector('.post-tags');
        (p.tags || []).forEach(t => {
          const tEl = document.createElement('div');
          tEl.className = 'tag';
          tEl.textContent = '#'+t;
          tEl.addEventListener('click', () => {
            activeTag = t;
            activeCategory = 'Semua';
            updateCategoryActiveStates();
            renderPosts();
            window.scrollTo({top:0, behavior:'smooth'});
          });
          tagsContainer.appendChild(tEl);
        });

        const repliesContainer = el.querySelector('.replies-section');
        renderReplies(p, repliesContainer);

        // Logika Tombol Salin Link
        el.querySelector('.shareBtn').addEventListener('click', () => {
          const url = new URL(location.href);
          url.hash = p.id;
          navigator.clipboard?.writeText(url.toString()).then(()=> {
            alert('Link topik disalin ke clipboard!');
          }).catch(()=> {
            prompt('Salin link ini:', url.toString());
          });
        });
        
        // Logika Submit Balasan
        el.querySelector('.reply-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const form = e.target;
          const formData = new FormData(form);
          const replyBody = formData.get('replyBody').trim();
          
          if(!replyBody) return alert('Balasan tidak boleh kosong.');
          
          const newReply = { body: replyBody, post_id: p.id };
          
          const { data, error } = await db.from('replies').insert(newReply).select().single();

          if (error) {
            alert('Gagal mengirim balasan: '.trim() + error.message);
          } else {
            p.replies = p.replies || [];
            p.replies.push(data); // Tambahkan balasan baru ke data lokal
            renderReplies(p, repliesContainer); // Render ulang daftar balasan
            form.reset();
          }
        });

        return el;
      }

      // Logika Submit Postingan Baru
      async function handleSubmit(event){
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const title = formData.get('title').trim();
        const body = formData.get('body').trim();
        const category = formData.get('category');
        const tags = parseTags(formData.get('tags'));

        if(!title || !body) return alert('Judul dan Isi topik tidak boleh kosong.');
        
        submitPostBtn.disabled = true;
        submitPostBtn.textContent = 'Memposting...';

        const newPost = { title, body, category, tags };
        
        // Insert data ke Supabase
        const { error } = await db.from('posts').insert(newPost);

        submitPostBtn.disabled = false;
        submitPostBtn.textContent = 'Posting';

        if(error) {
          alert('Gagal memposting: ' + error.message);
        } else {
          form.reset();
          activeCategory = 'Semua';
          activeTag = null;
          sortSelect.value = 'new';
          updateCategoryActiveStates();
          await fetchAndRenderPosts(); // Muat ulang data
          window.scrollTo({top:0, behavior:'smooth'});
        }
      }

      // Helper & Theme Functions
      function applySavedTheme(){
        const saved = localStorage.getItem(LS_THEME);
        const isDark = saved === 'dark';
        document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light'); // Set atribut tema

        if(isDark){
            themeBtn.textContent = 'Mode Terang';
            themeBtn.setAttribute('aria-pressed','true');
        } else {
            document.documentElement.removeAttribute('data-theme');
            themeBtn.textContent = 'Mode Gelap';
            themeBtn.setAttribute('aria-pressed','false');
        }
      }

      function toggleTheme(){
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        if(isDark){
          document.documentElement.removeAttribute('data-theme');
          localStorage.setItem(LS_THEME, 'light');
        } else {
          document.documentElement.setAttribute('data-theme','dark');
          localStorage.setItem(LS_THEME, 'dark');
        }
        applySavedTheme();
      }

      // Mencegah XSS (Cross-Site Scripting) dengan mengubah karakter khusus menjadi entitas HTML
      function escapeHtml(text){
        if(!text) return '';
        const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return text.replace(/[&<>"']/g, m => map[m]);
      }

      // Memformat tanggal menjadi format lokal (Indonesia)
      function formatDate(d){
        const opts = { day: '2-digit', month: 'short', year: 'numeric', hour:'2-digit', minute:'2-digit' };
        return new Intl.DateTimeFormat('id-ID', opts).format(d);
      }

      // Mencegah fungsi berjalan terlalu sering (mis. saat user mengetik)
      function debounce(fn, wait){
        let t;
        return function(...a){
          clearTimeout(t);
          t = setTimeout(()=>fn.apply(this,a), wait);
        }
      }

      // Scroll ke postingan jika ada ID di URL (misal: index.html#10)
      function tryOpenHash(){
        const h = location.hash.replace('#','');
        if(!h) return;
        
        const elem = document.querySelector(`[data-id="${h}"]`);
        if(elem){
          elem.scrollIntoView({behavior:'smooth', block:'center'});
          elem.style.transition = 'box-shadow .2s ease, transform .2s ease';
          elem.style.boxShadow = '0 0 0 3px var(--accent)'; // Beri highlight
          setTimeout(()=> elem.style.boxShadow = '', 2000); // Hilangkan highlight
        }
      }
      
      // Export objek global (opsional, untuk debugging)
      window.ForumBarBar = { posts, db, fetchAndRenderPosts };

    })();
  </script>
</body>
</html>
